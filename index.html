<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRUD Productos</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">

    <h2 class="text-center mb-4">CRUD – Productos (API REST)</h2>

    <!-- FORMULARIO -->
    <div class="card mb-4">
        <div class="card-header">Formulario Producto</div>
        <div class="card-body">
            <form id="formProducto">
                <input type="hidden" id="id">

                <div class="mb-3">
                    <label>Nombre</label>
                    <input type="text" id="nombre" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label>Código de Barra</label>
                    <input type="text" id="codigo_barra" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label>Precio</label>
                    <input type="number" id="precio" class="form-control" step="0.01" required>
                </div>

                <div class="mb-3">
                    <label>Stock</label>
                    <input type="number" id="stock" class="form-control" required>
                </div>

                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">Limpiar</button>
            </form>
        </div>
    </div>

    <!-- TABLA -->
    <div class="card">
        <div class="card-header">Lista de Productos</div>
        <div class="card-body">
            <table class="table table-bordered table-hover text-center">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Código</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody id="tablaProductos">
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
const API_URL = "http://127.0.0.1:8000/api/productos/?format=json";
const API_BASE = "http://127.0.0.1:8000/api/productos/";

// ===========================
// CARGAR LISTA
// ===========================
async function cargarProductos() {
    const res = await axios.get(API_URL);
    const productos = res.data;

    const tabla = document.getElementById("tablaProductos");
    tabla.innerHTML = "";

    productos.forEach(p => {
        tabla.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.nombre}</td>
                <td>${p.codigo_barra}</td>
                <td>$${p.precio}</td>
                <td>${p.stock}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editar(${p.id}, '${p.nombre}', '${p.codigo_barra}', ${p.precio}, ${p.stock})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminar(${p.id})">Eliminar</button>
                </td>
            </tr>
        `;
    });
}

cargarProductos();

// ===========================
// GUARDAR O EDITAR
// ===========================
document.getElementById("formProducto").addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = document.getElementById("id").value;

    const data = {
        nombre: document.getElementById("nombre").value,
        codigo_barra: document.getElementById("codigo_barra").value,
        precio: document.getElementById("precio").value,
        stock: document.getElementById("stock").value,
    };

    if (id) {
        await axios.put(API_BASE + id + "/", data);
        alert("Producto actualizado");
    } else {
        await axios.post(API_BASE, data);
        alert("Producto creado");
    }

    limpiarFormulario();
    cargarProductos();
});

// ===========================
// CARGAR DATOS AL FORM
// ===========================
function editar(id, nombre, codigo, precio, stock) {
    document.getElementById("id").value = id;
    document.getElementById("nombre").value = nombre;
    document.getElementById("codigo_barra").value = codigo;
    document.getElementById("precio").value = precio;
    document.getElementById("stock").value = stock;
}

// ===========================
// ELIMINAR
// ===========================
async function eliminar(id) {
    if (confirm("¿Eliminar producto?")) {
        await axios.delete(API_BASE + id + "/");
        alert("Producto eliminado");
        cargarProductos();
    }
}

// ===========================
// LIMPIAR FORMULARIO
// ===========================
function limpiarFormulario() {
    document.getElementById("id").value = "";
    document.getElementById("formProducto").reset();
}
</script>

</body>
</html>
